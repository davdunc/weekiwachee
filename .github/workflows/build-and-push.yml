name: Build and Push Mermaid CLI Container

# Triggers for the workflow
on:
  push:
    branches:
      - main  # Or your default branch (e.g., master)
    tags:
      - 'v*.*.*' # Trigger on version tags like v1.0.0
  workflow_dispatch: # Allows manual triggering from the Actions tab

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    # Permissions needed to push to GitHub Container Registry (GHCR)
    permissions:
      contents: read      # To checkout the repository
      packages: write     # To push packages (container images) to GHCR

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman
          podman --version # Verify installation

      - name: Set up QEMU (for multi-platform builds, optional if only building for amd64)
        uses: docker/setup-qemu-action@v3

      # --- Login to Container Registry ---
      # Option A: Login to GitHub Container Registry (GHCR) - Recommended for GitHub projects
      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin

      # Option B: Login to Docker Hub (Uncomment and configure secrets if using Docker Hub)
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Build and Push Image
        run: |
          # Image naming:
          # For GHCR: ghcr.io/OWNER/IMAGE_NAME (OWNER is your GitHub username or org name, needs to be lowercase)
          # For Docker Hub: docker.io/DOCKERHUB_USERNAME/IMAGE_NAME or just DOCKERHUB_USERNAME/IMAGE_NAME

          IMAGE_OWNER_GHCR=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="weekiwachee" # You can change this

          # Default to GHCR
          REGISTRY_PATH="ghcr.io/${IMAGE_OWNER_GHCR}/${IMAGE_NAME}"

          # --- Uncomment the line below if you are using Docker Hub ---
          REGISTRY_PATH="docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE_NAME}"
          # Or for personal Docker Hub without 'docker.io/' prefix if preferred by Podman:
          ## REGISTRY_PATH="${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE_NAME}"

          echo "Target registry path: ${REGISTRY_PATH}"

          # Create tags
          TAG_LATEST="latest"
          TAG_SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7) # Short commit SHA

          echo "Building image with tags: ${TAG_LATEST}, ${TAG_SHA_SHORT}"
          podman build \
            -t "${REGISTRY_PATH}:${TAG_LATEST}" \
            -t "${REGISTRY_PATH}:${TAG_SHA_SHORT}" \
            -f Containerfile .

          echo "Pushing image: ${REGISTRY_PATH}:${TAG_LATEST}"
          podman push "${REGISTRY_PATH}:${TAG_LATEST}"

          echo "Pushing image: ${REGISTRY_PATH}:${TAG_SHA_SHORT}"
          podman push "${REGISTRY_PATH}:${TAG_SHA_SHORT}"

          # If the workflow was triggered by a tag, also tag and push with that version
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG_VERSION="${{ github.ref_name }}" # e.g., v1.0.0
            echo "Workflow triggered by tag: ${TAG_VERSION}. Tagging and pushing this version."
            podman tag "${REGISTRY_PATH}:${TAG_LATEST}" "${REGISTRY_PATH}:${TAG_VERSION}"
            echo "Pushing image: ${REGISTRY_PATH}:${TAG_VERSION}"
            podman push "${REGISTRY_PATH}:${TAG_VERSION}"
          fi

      - name: Log out from registries
        if: always() # Run even if previous steps fail, to ensure logout
        run: |
          podman logout ghcr.io || echo "GHCR logout failed or was not logged in."
          podman logout docker.io || echo "Docker Hub logout failed or was not logged in." # Uncomment if using Docker Hub
